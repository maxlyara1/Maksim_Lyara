# Итоговый EDA

Ниже — итоговое описание набора данных и ключевые наблюдения по train/test. Все значения рассчитаны по исходным файлам `data/train.csv` и `data/test.csv`.

## 1) Общая структура данных

- Train: **29 100 строк × 19 колонок** (включая цели `price_p05`, `price_p95`).
- Test: **28 050 строк × 18 колонок** (включая `row_id`, без целевых).
- Колонка `dt` присутствует в обоих наборах, тип — дата.

## 2) Качество данных

- Пропуски: **0%** по всем признакам в train и test.
- Дубликаты по ключу `product_id + dt`: **0**.
- Валидность интервалов: случаев `price_p05 > price_p95` **нет**.
- Минимальная ширина интервала: **≈ 0.000109** (нулевых ширин нет).

## 3) Временная структура и покрытие товаров

- Диапазон дат:
  - Train: **2024‑03‑28 → 2024‑05‑26** (60 дат).
  - Test: **2024‑03‑28 → 2024‑06‑25** (90 дат).
- Train — полный прямоугольник **485 товаров × 60 дат** (каждый товар в каждый день).
- Test состоит из двух блоков:
  - **150 новых товаров** на всех 90 датах.
  - **485 “старых” товаров** только в будущих 30 датах (после 2024‑05‑26).
- Количество товаров на дату в test: либо **150**, либо **635**.

## 4) Признаки: описание и сравнение train/test

### 4.1 Иерархия и идентификаторы

- Уникальные значения (train/test одинаковы):
  - `management_group_id`: 7
  - `first_category_id`: 29
  - `second_category_id`: 76
  - `third_category_id`: 197
- `product_id`: **485** в train и **635** в test; **150** товаров — новые.

**Категории не закреплены за товаром и меняются по датам.**

Доля товаров с более чем одним значением:
- `management_group_id`: **≈ 85.15%**
- `first_category_id`: **≈ 96.91%**
- `second_category_id`: **100%**
- `third_category_id`: **100%**

**Частота смен категорий (по товару, 60 дат):**
- `management_group_id`: средн. **3.60** смен, доля без смен **≈ 14.85%**
- `first_category_id`: средн. **5.74**, доля без смен **≈ 3.09%**
- `second_category_id`: средн. **53.35**, доля без смен **0%**
- `third_category_id`: средн. **29.46**, доля без смен **0%**

**Энтропия распределений по товару (средняя):**
- `management_group_id`: **≈ 0.152**
- `first_category_id`: **≈ 0.195**
- `second_category_id`: **≈ 2.997**
- `third_category_id`: **≈ 0.686**

**Комбинации путей (4‑уровневая иерархия):**
- Уникальных путей: **13 491** в train, **13 284** в test.
- Доля путей test, отсутствующих в train: **≈ 58.7%**.
- Для новых товаров: **≈ 77.3%** путей не встречались в train.

### 4.2 Календарные признаки

- `month` в train: **3–5**, в test: **3–6**.
- `week_of_year` в train: **13–21**, в test: **13–26**.
- `dow`: **0–6**, `day_of_month`: **1–31** (полный охват).
- Проверка согласованности с `dt`: **0% несовпадений**.

**Флаги:**
- `holiday_flag`: среднее **0.3667** (train) vs **0.3214** (test).
- `activity_flag`: среднее **0.5489** (train) vs **0.5558** (test).

### 4.3 Числовые контекстные признаки

Признаки выглядят **стандартизированными** (есть отрицательные значения, средние близки к 0).

**Средние и std (train → test):**
- `n_stores`: **−0.0023 / 0.9899 → 0.1701 / 1.0128**
- `precpt`: **−0.1866 / 0.9618 → 0.3610 / 1.0141**
- `avg_temperature`: **−0.4748 / 0.8472 → 0.6606 / 0.9293**
- `avg_humidity`: **−0.0502 / 1.0185 → 0.2202 / 0.9849**
- `avg_wind_level`: **0.0604 / 1.1036 → 0.1048 / 0.8766**

**PSI (train vs test):**
- `n_stores`: **≈ 1.374**
- `avg_temperature`: **≈ 0.753**
- `precpt`: **≈ 0.702**
- `avg_humidity`: **≈ 0.514**
- `avg_wind_level`: **≈ 0.132**

**Внутридневная вариативность:**
для всех числовых признаков количество уникальных значений в рамках одной даты равно числу товаров (train — 485, test — 150/635). Это означает, что признаки меняются на уровне **товар × день**, а не являются общими для всей даты.

**Вариативность по товарам:**
- `n_stores` почти константен в разрезе товара: медианный std **≈ 0.0359**, доля std < 0.1 — **100%**.
- Погодные признаки существенно меняются: медианные std **≈ 0.231–0.691**.

**IQR‑выбросы (границы по train):**
- `n_stores`: **0.1167 → 0.1136**
- `precpt`: **0.1131 → 0.3478** (сильный рост в test)
- `avg_temperature`: **0.0000 → 0.0000**
- `avg_humidity`: **0.1300 → 0.1340**
- `avg_wind_level`: **0.0111 → 0.0051**

## 5) Целевые переменные

**Базовые статистики:**
- `price_p05`: mean **≈ 1.0215**, std **≈ 0.2469**, min **0.0000**, max **≈ 3.5122**
- `price_p95`: mean **≈ 1.1169**, std **≈ 0.2381**, min **≈ 0.000109**, max **≈ 3.5466**
- Ширина `price_p95 - price_p05`: mean **≈ 0.0954**, median **≈ 0.0521**, p75 **≈ 0.1557**, max **≈ 1.4180**

**Доля узких интервалов:**
- ширина < 0.001: **≈ 34.2%**
- ширина < 0.01: **≈ 36.8%**
- ширина < 0.05: **≈ 49.4%**
- ширина < 0.1: **≈ 62.6%**

**Нулевые нижние границы:**
- `price_p05 = 0`: **104 строки**, **4 товара**.

**Отношение `price_p95/price_p05` (без нулей):**
- среднее **≈ 1.136**, максимум **≈ 83.256**.
- `ratio > 5`: **36 строк**, всего **4 товара**.

**Выбросы ширины (IQR):**
- доля выбросов **≈ 2.26%**
- границы IQR **≈ [−0.232; 0.389]**

## 6) Связи и эффекты

**Корреляции с целями:**
- `price_p05` vs `price_p95`: **≈ 0.882**.
- `activity_flag` имеет наиболее сильную отрицательную связь с `price_p05` (**≈ −0.290**) и `price_p95` (**≈ −0.120**).
- `n_stores` слабо отрицательно связан с `price_p05` (**≈ −0.104**).
- Остальные числовые и календарные признаки дают почти нулевые корреляции.

**Эффект флагов (средние значения):**
- `holiday_flag`: влияние минимально (разница по `price_p05` ≈ −0.0018, по ширине ≈ −0.0045).
- `activity_flag`: заметный эффект — при активности **цены ниже**, ширина **выше**:
  - `price_p05`: **1.1005 → 0.9566** (Δ ≈ −0.1439)
  - `price_p95`: **1.1485 → 1.0910** (Δ ≈ −0.0575)
  - ширина: **0.0480 → 0.1344** (Δ ≈ +0.0864)

**Эффекты календаря:**
- По `dow` колебания слабые: `price_p05` **≈ 1.016–1.025**, ширина **≈ 0.0927–0.0983**.
- По `week_of_year` колебания заметнее: `price_p05` **≈ 1.007–1.041**, ширина **≈ 0.089–0.1019**.

**Связь уровня цены и ширины:**
- corr(width, `price_p05`) **≈ −0.313**
- corr(width, `price_p95`) **≈ 0.172**
- в лог‑шкале связь почти отсутствует (**≈ 0.025**)

## 7) Сдвиги и устойчивость

**PSI по категориальным признакам (train vs test):**
- `week_of_year`: **≈ 8.847**
- `month`: **≈ 8.032**
- `product_id`: **≈ 4.200**
- `third_category_id`: **≈ 0.694**
- остальные — близки к 0

**Сдвиг внутри train (первые 30 дат vs последние 30):**
- Наибольшие PSI по погоде: `avg_temperature` **≈ 7.32**, `avg_humidity` **≈ 1.25**.
- По календарю: `week_of_year` **≈ 21.85**, `month` **≈ 14.80**.
- Цели стабильны: PSI `price_p05` **≈ 0.0108**, `price_p95` **≈ 0.0102**.
- Средние цены в поздней половине ниже: `price_p05` **≈ −0.0129**, `price_p95` **≈ −0.0113**.

**Холодный старт (новые товары в test):**
- PSI (train vs новые товары): `n_stores` **≈ 1.074**, `precpt` **≈ 0.358**.
- Если ограничиться пересекающимися датами — PSI заметно ниже (например, `avg_temperature` **≈ 0.044**).
- Средние значения у новых товаров выше: `avg_temperature` **≈ 0.176** vs **−0.475** в train.

**PCA по числовым признакам:**
- PC1 **≈ 0.338**, PC2 **≈ 0.257**; суммарно **≈ 59.6%** дисперсии.
- Среднее PC1 в test смещено на **≈ +1.21**, что подтверждает сдвиг распределения.

## 8) Временная зависимость

**Lag‑1 автокорреляция внутри товара:**
- pooled corr: `price_p05` **≈ 0.669**, `price_p95` **≈ 0.599**, ширина **≈ 0.808**.
- медианные per‑product corr: **≈ 0.487 / 0.478 / 0.484** соответственно.
- доля товаров с corr > 0.5: **≈ 45–48%**.

## 9) Кластеризация и аномалии

**Кластеризация товаров (KMeans по агрегатам):**
- Лучшее k по silhouette: **2** (score **≈ 0.255**).
- Размеры кластеров: **322** и **163** товара.
- Средние по кластерам:
  - Кластер 0: `price_p05_mean` **≈ 1.095**, `width_mean` **≈ 0.051**
  - Кластер 1: `price_p05_mean` **≈ 0.876**, `width_mean` **≈ 0.183**

**Аномалии (IsolationForest):**
топ‑аномалии по товарам включают `product_id`: **452, 60, 291, 69, 591, 392, 624, 444, 89, 613** — они совпадают с экстремальными ширинами/отношениями цен.

## 10) Итоговые выводы

- Данные чистые и структурно полные, но **test существенно отличается** по времени, товарам и числовым признакам.
- Иерархия **динамична**, комбинации категорий сильно сдвинуты; модели должны быть устойчивы к unseen‑комбинациям.
- **Новые товары** составляют значимую часть test и имеют отличающиеся контекстные распределения.
- **Временная зависимость** целей заметна — лаговые признаки потенциально полезны.
- **Акции (`activity_flag`)** понижают цены и расширяют интервалы; `holiday_flag` почти нейтрален.
- **Погодные признаки** и `precpt` демонстрируют сильный сдвиг; тест содержит больше выбросов по `precpt`.